<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MicroSPA</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <script type="module">
      import microspa from './index.js'

      const ticker = (root, {start, delay}) => {
        start = (isNaN(start) ? 0 : parseInt(start)) - 1
        const update = () => {
          root.innerHTML = `<h1>Tick: ${++start}</h1>`
          console.log('tick: '+start)
        }
        update()
        const interval = setInterval(update, (delay || 1) * 1000)
        return () => {clearInterval(interval)}
      }

      const counter = (node, {start}) => import("https://unpkg.com/superfine")
        .then(({h, text, patch}) => {
          var stop = false
          const setState = (state) => stop ? null :
            patch(
              node,
              h(node.tagName.toLowerCase(), {}, [
                h("h1", {}, text(state)),
                h("button", { onclick: () => setState(state - 1) }, text("-")),
                h("button", { onclick: () => setState(state + 1) }, text("+")),
              ])
            )

          setState(isNaN(start) ? 0 : parseInt(start))

          return () => {stop = true}
        })

      const todo = (node, {value}) => import("https://unpkg.com/hyperapp")
        .then(({h, text, app}) => {
          var stop = false
          const AddTodo = (state) => stop ? state : ({
            ...state,
            value: "",
            todos: state.todos.concat(state.value),
          })

          const NewValue = (state, event) => stop ? state : ({
            ...state,
            value: event.target.value,
          })

          app({
            init: { todos: [], value: value || "" },
            view: ({ todos, value }) =>
              h(node.tagName.toLowerCase(), {}, [
                h("h1", {}, text("To do list")),
                h("input", { type: "text", oninput: NewValue, value }),
                h("ul", {},
                  todos.map((todo) => h("li", {}, text(todo)))
                ),
                h("button", { onclick: AddTodo }, text("New!")),
              ]),
            node: node
          })

          return () => {stop = true}
        })

      window.stop = microspa(document.getElementById('app'), {
        components: {
          ticker,
          counter,
          todo
        },
        routes: {
          '/counter/:start': counter,
          '/todo': todo,
          '/ticker': ticker,
          '/view': 'ms-view'
        }
      })
    </script>
  </head>
  <body>
    <nav>
      <a href="#/">Home</a>
      <a href="#/todo">Todo</a>
      <a href="#/ticker">Ticker</a>
      <a href="#/view">View with 2 tickers</a>
      <a href="#/counter/7">Counter 7</a>
      <a href="#/this/is/404">Not Founded</a>
      <a href="javascript:;" onclick="stop()">Stop Router</a>
      <a href="tests">Test page</a>
    </nav>
    <main id="app">
      <h1>MicroSPA</h1>
      <p>Hello world! From MicroSPA</p>
      <ms-counter start=15></ms-counter>
      <ms-todo value=read></ms-todo>
    </main>
    <template id="ms-view">
      <h1>Some template defined view with 2 tickers</h1>
      <ms-ticker></ms-ticker>
      <ms-ticker start="10"></ms-ticker>
    </template>
    <template id="ms-error">
      <h1>Error!</h1>
      <p>Error executing script!</p>
      <p>Please check browser logs!</p>
    </template>
    <template id="ms-loading">
      <h1>Loading...</h1>
    </template>
  </body>
</html>
